<!-- |--------- PAGE LOADER - MARKUP ---------| -->
<ngx-ui-loader></ngx-ui-loader>

<!-- |--------- APP-INSTRUCTIONS COMPONENT - MARKUP ---------| -->
<app-instructions
  [scale]="this.scale"
  [s3]="this.s3"
  [bucket]="this.bucket"
  [instructionsFile]="this.taskInstructionsFile">
</app-instructions>

<!-- |--------- TOKEN INPUT SECTION - MARKUP ---------| -->
<div id="token-section" class="container" *ngIf="!taskStarted && taskAllowed;">
  <form [formGroup]="tokenForm">
    <mat-card>
      <mat-card-content>
        <mat-form-field>
          <mat-label>
            Insert your input token
          </mat-label>
          <input matInput type="text" placeholder="your_mturk_token" formControlName="tokenInput" maxlength="11"
                 (focus)="this.tokenForm.updateValueAndValidity()"
                 (paste)="this.tokenForm.updateValueAndValidity()"
                 (keyup)="this.tokenForm.updateValueAndValidity()"
                 (keydown)="this.tokenForm.updateValueAndValidity()"
                 (keyup.enter)="performTaskSetup()"
          >
          <mat-error *ngIf="checkFormControl(tokenForm,'tokenInput', 'required')">
            This field is required
          </mat-error>
          <mat-error *ngIf="checkFormControl(tokenForm,'tokenInput', 'invalid')">
            This token input is invalid
          </mat-error>
          <mat-error *ngIf="checkFormControl(tokenForm,'tokenInput', 'maxlength')">
            This token input should be 11 characters long
          </mat-error>
        </mat-form-field>
      </mat-card-content>
      <mat-card-actions>
        <button id="start-button" mat-flat-button color="primary" (click)="performTaskSetup()">Start</button>
      </mat-card-actions>
      <span class="form-note"><small>(*) If you have a very slow internet connection please wait a few seconds before clicking "Start".</small></span>
    </mat-card>
  </form>
</div>


<!--
     If the worker has a valid token input and has not started the task
     render the task's body section and do not render the <alreadyStarted>
     section. This behavior depends on <taskAllowed> flag
-->
<ng-template *ngIf="(taskAllowed); else alreadyStarted"></ng-template>

<!-- |--------- ALREADY STARTED SECTION - MARKUP ---------| -->
<ng-template #alreadyStarted>
  <div id="already-started-section" class="outcome-section container">
    <div>
      <mat-card>
        <mat-card-title class="failure-title">
          <h4>Failure</h4>
        </mat-card-title>
        <mat-card-content>
          <h2>
            Either you have already started this task without finishing it, or you have already participated to a
            variant of this experiment.<br/>
            For this reason, you are not allowed to take a part in this experiment. Sorry for the inconvenience.
          </h2>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</ng-template>

<!-- |---------  TASK BODY SECTION - MARKUP ---------| -->
<mat-horizontal-stepper [linear]="true" labelPosition="bottom" #stepper *ngIf="taskStarted">

  <!-- Questionnaire markup -->
  <mat-step *ngFor="let questionnaire of questionnaires; let i=index" [stepControl]="questionnairesForm[i]" [editable]="false">
    <div class="container">
      <form [formGroup]="questionnairesForm[i]" class="questionnaire-form">
        <ng-template matStepLabel>Q{{i + 1}}</ng-template>
        <mat-card>
          <mat-divider [inset]="true"></mat-divider>
          <mat-card-title *ngIf="questionnaire.type=='standard'">Please answer the following questions</mat-card-title>
          <mat-card-title *ngIf="questionnaire.type=='crt'">Please answer the following question</mat-card-title>
          <mat-divider [inset]="true"></mat-divider>
          <mat-card-content *ngIf="questionnaire.type=='standard'">
            <mat-radio-group *ngFor="let question of questionnaire.questions; let j=index" aria-labelledby="radio-button-label" class="radio-button-group question" formControlName="{{question.name}}">
              <div class="question-text">
                <label>{{question.text}}</label>
              </div>
              <mat-radio-button *ngFor="let answer of question.answers; let k=index" class="radio-button" value="{{k}}">{{answer}}</mat-radio-button>
            </mat-radio-group>
          </mat-card-content>
          <mat-card-content *ngIf="questionnaire.type=='crt'">
            <mat-form-field *ngFor="let question of questionnaire.questions; let j=index">
              <label>{{question.text}}</label>
              <input matInput type="number" placeholder="" formControlName="{{question.name}}">
              <mat-error *ngIf="checkFormControl(questionnairesForm[i],question.name, 'required')">
                This field is required
              </mat-error>
              <mat-error *ngIf="checkFormControl(questionnairesForm[i],question.name, 'min')">
                Min value allowed: 0
              </mat-error>
              <mat-error *ngIf="checkFormControl(questionnairesForm[i],question.name, 'max')">
                Max value allowed: 100
              </mat-error>
            </mat-form-field>
          </mat-card-content>
          <mat-card-actions>
            <button mat-flat-button color="primary" matStepperNext
                    [disabled]="(!questionnairesForm[i].valid || taskCompleted)"
                    (click)="performLogging('Next')">
              Next
            </button>
            <span class="form-note">(*) you have to fill each field to proceed</span>
          </mat-card-actions>
        </mat-card>
      </form>
    </div>
  </mat-step>

  <!-- Documents markup -->
  <mat-step *ngFor="let document of documents; let i=index" [editable]="true">
    <div class="container">
      <form [formGroup]="documentsForm[i]">
        <mat-card>
          <ng-template matStepLabel> S{{i + 1}}</ng-template>
          <mat-divider [inset]="true"></mat-divider>
          <mat-card-title>Please judge the truthfulness of the following statement</mat-card-title>
          <mat-divider [inset]="true"></mat-divider>
          <mat-card-content>
            <!-- Statement markup -->
            <div class="statement">
              <ul>
                <li><strong>Claimant/Source</strong> (who made the statement): {{document.claimant}}</li>
                <li><strong>Date</strong> (when the statement was made): {{document.date}}</li>
                <li><strong>Text</strong> (content of the statement): {{document.statement}}</li>
              </ul>
            </div>
            <!-- Instructions markup -->
            <div class="instructions">
              <mat-divider [inset]="true"></mat-divider>
              <h2>Instructions</h2>
              <mat-divider [inset]="true"></mat-divider>
              <p>{{instructions.caption}}</p>
              <ol *ngIf="instructions.steps.length>0">
                <li *ngFor="let step of this.instructions.steps"><p>{{step}}</p></li>
              </ol>
            </div>
            <!-- Dimensions markup -->
            <div *ngFor="let dimension of this.dimensions; let j=index" class="dimension">
              <!-- Dimension description markup -->
              <div *ngIf="dimension.description != ''" class="dimension-description">
                <mat-divider [inset]="true"></mat-divider>
                <h2>Question</h2>
                <mat-divider [inset]="true"></mat-divider>
                <p>{{dimension.description}}</p>
              </div>
              <!-- Dimension search engine interface markup -->
              <div class="search-engine">
                <div *ngIf="dimension.url">
                  <mat-divider [inset]="true"></mat-divider>
                  <h2>Step 1</h2>
                </div>
                <mat-divider [inset]="true"></mat-divider>
                <app-crowd-xplorer *ngIf="dimension.url" id="app-crowd-xplorer-{{i}}-{{j}}"
                                   (resultEmitter)="storeSearchEngineRetrievedResponse($event)"
                                   (queryEmitter)="storeSearchEngineUserQuery($event)"
                                   (selectedRowEmitter)="storeSearchEngineSelectedResponse($event)"
                ></app-crowd-xplorer>
              </div>
              <!-- Dimension search engine url field markup (hidden) -->
              <mat-form-field *ngIf="dimension.url" class="url-field">
                <input #urlField matInput type="text" formControlName="{{(dimension.name).concat('_url')}}">
                <button mat-icon-button matPrefix>
                  <mat-icon>{{'arrow_right_alt'}}</mat-icon>
                </button>
                <mat-error *ngIf="checkFormControl(documentsForm[i],(dimension.name).concat('_url'), 'required')">
                  This field is required
                </mat-error>
                <mat-error *ngIf="checkFormControl(documentsForm[i], (dimension.name).concat('_url'), 'invalidSearchEngineUrl')">
                  Please select (or copy & paste) one of the URLs shown above.
                </mat-error>
              </mat-form-field>
              <!-- Dimension truth level field markup -->
              <div class="truth-level">
                <div *ngIf="!dimension.url">
                  <mat-divider [inset]="true"></mat-divider>
                  <h2>Step 1</h2>
                  <mat-divider [inset]="true"></mat-divider>
                </div>
                <div *ngIf="dimension.url">
                  <mat-divider [inset]="true"></mat-divider>
                  <h2>Step 2</h2>
                  <mat-divider [inset]="true"></mat-divider>
                </div>
                <mat-radio-group *ngIf="this.scale=='S6'" aria-labelledby="radio-button-label" class="radio-button-group" formControlName="{{(dimension.name).concat('_value')}}">
                  <mat-radio-button class="radio-button" value="1">
                    <strong>Lie</strong> (The statement is not accurate and makes a ridicolous claim)
                  </mat-radio-button>
                  <mat-radio-button class="radio-button" value="2">
                    <strong>False</strong> (The statement is not accurate)
                  </mat-radio-button>
                  <mat-radio-button class="radio-button" value="3">
                    <strong>Mostly False</strong> (The statement contains an element of truth but ignores critical facts that would give a different impression)
                  </mat-radio-button>
                  <mat-radio-button class="radio-button" value="4">
                    <strong>Half True</strong> (The statement is partially accurate but leaves out important details or takes things out of context)
                  </mat-radio-button>
                  <mat-radio-button class="radio-button" value="5">
                    <strong>Mostly True</strong> (The statement is accurate but needs clarification or additional information)
                  </mat-radio-button>
                  <mat-radio-button class="radio-button" value="6">
                    <strong>True</strong> (The statement is accurate and there is nothing significant missing)
                  </mat-radio-button>
                </mat-radio-group>
                <mat-radio-group *ngIf="this.scale=='S3'" aria-labelledby="radio-button-label" class="radio-button-group" formControlName="{{(dimension.name).concat('_value')}}">
                  <mat-radio-button class="radio-button" value="1">Negative</mat-radio-button>
                  <mat-radio-button class="radio-button" value="2">In Between</mat-radio-button>
                  <mat-radio-button class="radio-button" value="3">Positive</mat-radio-button>
                </mat-radio-group>
                <label *ngIf="this.scale=='S100'">Selected value: {{documentsForm[i].controls[(dimension.name).concat('_value')].value}}</label>
                <mat-slider *ngIf="this.scale=='S100'" min="0" max="100" step="1" thumbLabel tickInterval="1" formControlName="{{(dimension.name).concat('_value')}}"></mat-slider>
              </div>
              <!-- Dimension text justification field markup -->
              <div *ngIf="dimension.justification==true" class="justification">
                <div *ngIf="!dimension.url">
                  <mat-divider [inset]="true"></mat-divider>
                  <h2>Step 2</h2>
                  <mat-divider [inset]="true"></mat-divider>
                </div>
                <div *ngIf="dimension.url">
                  <mat-divider [inset]="true"></mat-divider>
                  <h2>Step 3</h2>
                  <mat-divider [inset]="true"></mat-divider>
                </div>
                <div class="dimension-text-field">
                  <mat-form-field appearance="fill">
                    <mat-label>Your justification here (You can use/copy text from the selected url)</mat-label>
                    <textarea matInput formControlName="{{dimension.name}}_justification" rows="3"></textarea>
                    <mat-error *ngIf="checkFormControl(documentsForm[i],(dimension.name).concat('_justification'), 'required')">
                      This field is required
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </mat-card-content>
          <!-- Actions markup -->
          <mat-card-actions>
            <button mat-flat-button color="primary" matStepperPrevious *ngIf="i>0"
                    [disabled]="taskCompleted"
                    (click)="performLogging('Back')">
              Back
            </button>
            <button mat-flat-button color="primary" matStepperNext
                    *ngIf="i+1<this.documentsAmount"
                    [disabled]="!documentsForm[i].valid || !this.searchEngineRetrievedResponses[i] || taskCompleted"
                    (click)="performLogging('Next');">
              Next
            </button>
            <button mat-flat-button color="primary" matStepperNext
                    *ngIf="i+1>=this.documentsAmount"
                    [disabled]="(!performGlobalValidityCheck()) || taskCompleted"
                    (click)="performLogging('Finish'); performQualityCheck()">
              Finish
            </button>
            <span class="form-note">(*) you have to fill each field to proceed</span>
          </mat-card-actions>
        </mat-card>
      </form>
    </div>
  </mat-step>

  <!-- Outcome markup -->
  <mat-step *ngIf="documents" [editable]="false">
    <ng-template matStepLabel> Outcome</ng-template>
    <!-- Success section - shown when the worker successfully completes the task -->
    <div id="success-section" class="outcome-section container" *ngIf="taskCompleted && taskSuccessful">
      <mat-card>
        <mat-card-title class="success-title">
          <h4>Success</h4>
        </mat-card-title>
        <mat-card-content>
          <h2>
            Congratulations, you have successfully completed this task. To be paid you now have to copy your output token
            (shown below)
            back to the Amazon Mechanical Turk task page. Feel free to leave any comment in the box below to help us
            improve our research.
          </h2>
          <h1>{{tokenOutput}}</h1>
          <form [formGroup]="commentForm" class="comment-form">
            <mat-form-field appearance="fill">
              <textarea matInput [disabled]="commentSent" placeholder="Your comment here" formControlName="comment" rows="5"></textarea>
            </mat-form-field>
          </form>
          <button mat-flat-button color="primary" [disabled]="commentSent || !commentForm.valid " (click)="performCommentSaving()"> Send
          </button>
          <span class="comment-sent-label" *ngIf="commentSent">Thank you!</span>
        </mat-card-content>
      </mat-card>
    </div>
    <!-- Retry section - shown when the worker does not pass the quality checks but has some tries left -->
    <div id="retry-section" class="outcome-section container" *ngIf="taskCompleted && taskFailed && allowedTries>0">
      <div>
        <mat-card>
          <mat-card-title class="retry-title">
            <h3>Failure, but...</h3>
          </mat-card-title>
          <mat-card-content>
            <h2>
              Your work was not good enough, so you are not allowed to submit this task.
              As stated in the instructions, some quality checks are performed in this task.
              You see this message because you have not passed one or more of such checks.
              Nevertheless, you are allowed to retry this task. To do so, please click on the reset button below.
              Feel free to leave any comment in the box below.
            </h2>
            <button mat-flat-button color="primary" (click)="performReset()">Reset</button>
            <form [formGroup]="commentForm" class="comment-form">
              <mat-form-field appearance="fill">
            <textarea matInput [disabled]="commentSent" placeholder="Your comment here" formControlName="comment"
                      rows="5"></textarea>
              </mat-form-field>
            </form>
            <button mat-flat-button color="primary" [disabled]="commentSent || !commentForm.valid "
                    (click)="performCommentSaving()"> Send
            </button>
            <span class="comment-sent-label" *ngIf="commentSent">Thank you!</span>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
    <!-- Failure section - shown when the worker does not pass the quality checks and does not has tries left -->
    <div id="failure-section" class="outcome-section container" *ngIf="taskCompleted && taskFailed && allowedTries <= 0">
      <div>
        <mat-card>
          <mat-card-title class="failure-title">
            <h4>Failure</h4>
          </mat-card-title>
          <mat-card-content>
            <h2>
              Your work was not good enough, so you are not allowed to submit this task.
              As stated in the instructions, some quality checks are performed in this task.
              You see this message because you have not passed one or more of such checks.
              Feel free to leave any comment in the box below.
            </h2>
            <form [formGroup]="commentForm" class="comment-form">
              <mat-form-field appearance="fill">
                <textarea matInput [disabled]="commentSent" placeholder="Your comment here" formControlName="comment" rows="5"></textarea>
              </mat-form-field>
            </form>
            <button mat-flat-button color="primary" [disabled]="commentSent || !commentForm.valid "
                    (click)="performCommentSaving()"> Send
            </button>
            <span class="comment-sent-label" *ngIf="commentSent">Thank you!</span>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </mat-step>

</mat-horizontal-stepper>
