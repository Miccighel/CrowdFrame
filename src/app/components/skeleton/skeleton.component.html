<!-- First instruction page shown when the worker starts the skeleton -->
<div class="instructions-section" *ngIf="this.sectionService.checkCompleted && this.sectionService.currentSection == 'instructions-section'">
    <mat-card>
        <mat-card-content *ngIf="!this.sectionService.checkCompleted || !this.task.instructionsGeneral">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </mat-card-content>
        <mat-card-content *ngIf="this.sectionService.checkCompleted && this.task.instructionsGeneral">
            <ng-container *ngFor="let instruction of this.task.instructionsGeneral; let i=index">
                <h2 *ngIf="instruction['caption']">{{instruction["caption"]}}</h2>
                <span [innerHTML]="instruction.text"></span>
            </ng-container>
        </mat-card-content>
        <mat-card-actions>
            <button mat-flat-button color="primary" (click)="enableTask()" [disabled]="!this.sectionService.checkCompleted || !this.task.instructionsGeneral">
                Proceed
            </button>
        </mat-card-actions>
    </mat-card>
</div>

<!-- Instructions modal shown on the top  -->
<app-instructions [instructions]="this.task.instructionsGeneral" *ngIf="this.sectionService.instructionsAllowed"></app-instructions>

<!-- Token input section -->
<div id="token-section" class="container" *ngIf="this.sectionService.currentSection == 'token-section'">
    <form [formGroup]="tokenForm">
        <mat-card>
            <mat-card-content>
                <mat-form-field appearance="fill">
                    <mat-label>
                        Insert your input token
                    </mat-label>
                    <input matInput type="text" placeholder="your_mturk_token" formControlName="tokenInput" maxlength="11" class="input-token"
                           (focus)="this.tokenForm.updateValueAndValidity()" (paste)="this.tokenForm.updateValueAndValidity()"
                           (keyup)="this.tokenForm.updateValueAndValidity()" (keydown)="this.tokenForm.updateValueAndValidity()"
                           (keyup.enter)="performTaskSetup()">
                    <mat-error *ngIf="this.utilsService.checkFormControl(tokenForm,'tokenInput', 'required')">
                        This field is required
                    </mat-error>
                    <mat-error *ngIf="this.utilsService.checkFormControl(tokenForm,'tokenInput', 'invalid')">
                        This token input is invalid
                    </mat-error>
                    <mat-error *ngIf="this.utilsService.checkFormControl(tokenForm,'tokenInput', 'maxlength')">
                        This token input should be 11 characters long
                    </mat-error>
                </mat-form-field>
            </mat-card-content>
            <mat-card-actions>
                <button mat-flat-button color="primary" (click)="performTaskSetup()">Start</button>
            </mat-card-actions>
        </mat-card>
    </form>
</div>

<!-- Already started section -->

<div id="already-started-section">
    <app-outcome-section
            *ngIf="!this.sectionService.taskAllowed"
            [platformName]="this.configService.environment.platformName"
            [triesAllowed]="this.task.settings.allowed_tries"
            [tryCurrent]="this.task.tryCurrent"
            [messages]="this.task.settings.messages"
            [tokenOutput]="this.task.tokenOutput"
            [completionCode]="this.configService.environment.prolific_completion_code"
            (commentEmitter)="performCommentSaving($event)"
            (performReset)="this.performReset()"
    ></app-outcome-section>
</div>

<!-- Task body section -->

<mat-horizontal-stepper [linear]="true" labelPosition="bottom" id="stepper" #stepper *ngIf="this.task.settings && this.task.documents && this.task.questionnaires && this.task.dimensions && this.sectionService.taskStarted">

    <!-- Questionnaire markup -->
    <ng-container *ngFor="let questionnaire of this.task.questionnaires; let i=index">
        <mat-step *ngIf="questionnaire.position=='start' || !questionnaire.position" [stepControl]="questionnairesForm[i]" [editable]="false">
            <ng-template matStepLabel>Q{{i + 1}}</ng-template>
            <app-questionnaire
                    id="questionnaire-start-{{i}}"
                    [step]="i"
                    [position]=questionnaire.position
                    [documentsAmount]="this.task.documentsAmount"
                    [questionnaire]="questionnaire"
                    [questionnaireAmount]="this.task.questionnaireAmount"
                    [questionnaireAmountStart]="this.task.questionnaireAmountStart"
                    [questionnaireAmountEnd]="this.task.questionnaireAmountEnd"
                    [questionnaireForm]="questionnairesForm[i]"
                    [taskCompleted]="this.sectionService.taskCompleted"
                    (questionnaireFilled)="handleQuestionnaireFilled($event)">
            </app-questionnaire>
        </mat-step>
    </ng-container>

    <!-- Documents markup -->
    <mat-step *ngFor="let document of this.task.documents; let i=index" [editable]="true">
        <div class=" container">
            <form [formGroup]="documentsForm[i]">
                <mat-card>

                    <!-- Document header markup -->
                    <ng-template matStepLabel> S{{document.index + 1}}</ng-template>
                    <mat-divider [inset]="true"></mat-divider>
                    <mat-card-title>Statement Nr. {{i + 1}}</mat-card-title>
                    <mat-divider [inset]="true"></mat-divider>
                    <mat-card-content class="pt-16px">

                        <!-- Evaluation instructions markup -->
                        <div *ngIf="this.task.instructionsEvaluationAmount>0" class="evaluation-instructions">
                            <mat-divider [inset]="true"></mat-divider>
                            <h2>Instructions</h2>
                            <mat-divider [inset]="true"></mat-divider>
                            <div *ngFor="let instruction of this.task.instructionsEvaluation">
                                <h2>{{instruction.caption}}</h2>
                                <div [innerHTML]="instruction.text"></div>
                            </div>
                        </div>

                        <!--- Countdown markup --->
                        <div class="countdown sticky" *ngIf="this.task.settings.countdown_time>=0">
                            <h1 class="text-lighter m-0">
                                Time left:
                                <countdown #countdownElement [config]="{ demand: true, leftTime: this.task.documentsCountdownTime[i], format: 'mm:ss' }" (event)="handleCountdown($event, i)"></countdown>
                            </h1>
                        </div>

                        <ng-container *ngIf="(this.task.settings.modality=='pointwise')">

                            <ng-container *ngIf="!(this.task.settings.annotator)">
                                <app-element-pointwise [task]="this.task" [documentIndex]="i"></app-element-pointwise>
                            </ng-container>
                            <ng-container *ngIf="(this.task.settings.annotator)">
                                <app-annotator-laws *ngIf="(this.task.settings.annotator.type=='laws')" [task]="this.task" [documentIndex]="i"></app-annotator-laws>
                                <app-annotator-options *ngIf="(this.task.settings.annotator.type=='options')" [task]="this.task" [documentIndex]="i"></app-annotator-options>
                            </ng-container>

                        </ng-container>


                        <ng-container *ngIf="(this.task.settings.modality=='pairwise')">
                            <h2 class="titlepairwise">Choose the statement</h2>
                            <mat-radio-group formControlName="pairwise_value_selected">
                                <div class="pairwise-cointainer">
                                    <div class="divsplit">
                                        <div class="statementsplit" id="StatementA.{{document.index}}">
                                            <div class="parent">
                                                <h3 class="statementTitlesplit">Statement A</h3>
                                                <div class="boxtextsplit">
                                                    <span class="spanboxtext">{{document.statements[0][0].statement}}</span>
                                                </div>
                                                <div class="boxvaluessplit">
                                                    <ng-container *ngFor="let attribute of this.task.settings.attributes; let k=index">
                                                            <span class="captionsplit" *ngIf="attribute.show==true">
                                                                <label><strong>{{attribute.name}}</strong></label>
                                                                {{document.statements[0][0][attribute.name]}}
                                                            </span>
                                                    </ng-container>
                                                </div>
                                                <mat-radio-button class="tester" value="A"
                                                                  (change)="this.task.storeDimensionValue($event, i, document.index) ; changeColor($event,document.index); changeColorRadio($event,document.index)"
                                                                  disableRipple="true">
                                                    <div style=" width: 500px; height: 300px;"></div>
                                                </mat-radio-button>
                                            </div>
                                        </div>
                                        <div class="statementsplit" id="StatementB.{{document.index}}">
                                            <div class="parent">
                                                <h3 class="statementTitlesplit">Statement B</h3>
                                                <div class="boxtextsplit">
                                                    {{document.statements[0][1].statement}}
                                                </div>
                                                <div class="boxvaluessplit">
                                                    <ng-container *ngFor="let attribute of this.task.settings.attributes; let k=index">
                                                            <span class="captionsplit" *ngIf="attribute.show==true">
                                                                <label><strong>{{attribute.name}}</strong></label>
                                                                {{document.statements[0][1][attribute.name]}}
                                                            </span>
                                                    </ng-container>
                                                </div>
                                                <mat-radio-button class="tester" value="B" (change)="this.task.storeDimensionValue($event, i, document.index) ; changeColor($event,document.index);changeColorRadio($event,document.index)"
                                                                  disableRipple="true">
                                                    <div style="width: 500px; height: 300px;"></div>
                                                </mat-radio-button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="div_radiobutton_check_pairwise">
                                    <mat-radio-button value="A" id="radioStatementA.{{document.index}}" class="radiobutton_check_pairwise"
                                                      (change)="this.task.storeDimensionValue($event, i, document.index) ; changeColor($event,document.index); changeColorRadio($event,document.index)" disableRipple="true">
                                        <span class="spanbutton">Statement A</span>
                                    </mat-radio-button>
                                    <mat-radio-button value="Both" id="radioStatementBoth.{{document.index}}" class="radiobutton_check_pairwise both_radio"
                                                      (change)="this.task.storeDimensionValue($event, i, document.index);changeColor($event,document.index); changeBoth(document.index)">
                                        <span class="both">Both statement</span>
                                    </mat-radio-button>
                                    <mat-radio-button value="B" id="radioStatementB.{{document.index}}" class="radiobutton_check_pairwise"
                                                      (change)="this.task.storeDimensionValue($event, i, document.index) ;changeColor($event,document.index);changeColorRadio($event,document.index)" disableRipple="true">
                                        <span class="spanbutton">Statement B</span>
                                    </mat-radio-button>
                                </div>
                            </mat-radio-group>
                        </ng-container>


                        <ng-template #dimensionList let-dimensions="dimensions" let-i="i">

                            <div *ngFor="let dimension of dimensions; let j=index" class="dimension'">

                                <ng-container *ngIf="this.task.settings.modality=='pointwise'">
                                    <div class="dimension-name">
                                        <div>
                                            <mat-divider [inset]="true"></mat-divider>
                                            <h2 *ngIf="!dimension.name_pretty">{{this.utilsService.capitalize(dimension.name)}}</h2>
                                            <h2 *ngIf="dimension.name_pretty">{{this.utilsService.capitalize(dimension.name_pretty)}}</h2>
                                            <mat-divider [inset]="true"></mat-divider>
                                        </div>
                                    </div>
                                    <div *ngIf="dimension.description" class="dimension-container dimension-description">
                                        <div class="dimension-content">
                                            <p>{{dimension.description}}</p>
                                        </div>
                                    </div>
                                </ng-container>

                                <ng-container *ngIf="this.task.settings.modality=='pairwise'">

                                    <!-- Dimension name markup -->
                                    <!--@AggiunteAbbondo Cambia la classe in base sei ci troviamo in modalità pairwise o meno-->
                                    <div [ngClass]="'dimension-content-split'">
                                        <div [ngClass]="'dimension-name-center'">
                                            <mat-divider [inset]="true"></mat-divider>
                                            <h2 *ngIf="!dimension.name_pretty">{{this.utilsService.capitalize(dimension.name)}}</h2>
                                            <h2 *ngIf="dimension.name_pretty">{{this.utilsService.capitalize(dimension.name_pretty)}}</h2>
                                            <mat-divider [inset]="true"></mat-divider>
                                        </div>
                                    </div>

                                    <!-- Dimension description markup -->
                                    <!-- @AggiunteAbbondo Cambiamo la classe in base sei ci troviamo in modalità pairwise o meno-->
                                    <div *ngIf="dimension.description" [ngClass]="'dimension-name-center'">
                                        <div class="dimension-content" ngClass=" 'dimension-split-inside' 'dimension-content'">
                                            <p>{{dimension.description}}</p>
                                        </div>
                                    </div>
                                </ng-container>


                                <!-- Dimension search engine interface markup -->
                                <div *ngIf="dimension.url" class="dimension-container dimension-url">
                                    <div class="dimension-counter">a.</div>
                                    <div class="dimension-content search-engine">
                                        <app-crowd-xplorer
                                                *ngIf="dimension.url" id="app-crowd-xplorer-{{i}}-{{j}}"
                                                (resultEmitter)="handleSearchEngineRetrievedResponse($event, document, dimension)"
                                                (queryEmitter)="this.task.storeSearchEngineUserQuery($event, document, dimension)"
                                                (selectedRowEmitter)="handleSearchEngineSelectedResponse($event, document, dimension)"
                                                [countdownExpired]="this.task.countdownsExpired[i]"
                                                [countdownBehavior]="this.task.settings.countdown_behavior">
                                        </app-crowd-xplorer>
                                        <!-- Dimension search engine url field markup (hidden) -->
                                        <mat-form-field *ngIf="dimension.url" class="url-field">
                                            <input #urlField matInput type="text" formControlName="{{(dimension.name).concat('_url')}}">
                                            <button mat-icon-button matPrefix>
                                                <mat-icon>{{'arrow_right_alt'}}</mat-icon>
                                            </button>
                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_url'), 'required')">
                                                This field is required
                                            </mat-error>
                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i], (dimension.name).concat('_url'), 'invalidSearchEngineUrl')">
                                                Please select (or copy & paste) one of the URLs shown above.
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                </div>


                                <ng-container *ngIf="this.task.settings.modality=='pointwise'">

                                    <div *ngIf="dimension.scale" class="dimension-container dimension-scale">
                                        <div *ngIf="dimension.url" class="dimension-counter">b.</div>
                                        <div class="dimension-content">

                                            <ng-container *ngIf="dimension.style.orientation=='vertical'">
                                                <ng-container *ngIf="dimension.scale.type=='categorical'">
                                                    <div>
                                                        <mat-radio-group aria-labelledby="radio-button-label" class="radio-button-group" formControlName="{{(dimension.name).concat('_value')}}">
                                                            <ng-container *ngFor="let mapping of dimension.scale.mapping let k=index">
                                                                <mat-divider *ngIf="mapping.separator" [inset]="true"></mat-divider>
                                                                <mat-radio-button
                                                                        value="{{mapping.value}}"
                                                                        (change)="this.task.storeDimensionValue($event, i, dimension.index);changeValue(document.index,dimension.index+1,j)"
                                                                        [disabled]="this.task.countdownsExpired[i]"
                                                                        [ngClass]="mapping.separator ? 'radio-button radio-button-separated' : 'radio-button'">
                                                                    <span>{{mapping.label}}</span>
                                                                    <span *ngIf="mapping.description.length>0"> ({{mapping.description}})</span>
                                                                </mat-radio-button>
                                                            </ng-container>
                                                        </mat-radio-group>
                                                    </div>
                                                </ng-container>

                                                <ng-container *ngIf="dimension.scale.type=='interval'">
                                                    <div>
                                                        <label>Selected value: {{documentsForm[i].controls[(dimension.name).concat('_value')].value}}</label>
                                                        <mat-slider
                                                                min="{{dimension.scale.min}}" max="{{dimension.scale.max}}"
                                                                step="{{dimension.scale.step}}" thumbLabel tickInterval="{{dimension.scale.step}}"
                                                                formControlName="{{(dimension.name).concat('_value')}}"
                                                                (change)="this.task.storeDimensionValue($event, i,dimension.index);"
                                                                [disabled]="this.task.countdownsExpired[i]">
                                                        </mat-slider>
                                                    </div>
                                                </ng-container>

                                                <ng-container *ngIf="dimension.scale.type=='magnitude_estimation'">
                                                    <mat-form-field appearance="fill">
                                                        <mat-label>Value</mat-label>
                                                        <input *ngIf="dimension.scale.lower_bound" matInput type="number" placeholder="" formControlName="{{(dimension.name).concat('_value')}}" min="{{dimension.scale.min}}"
                                                               (change)="this.task.storeDimensionValue($event, i, dimension.index)"
                                                               [disabled]="this.task.countdownsExpired[i]" class="magnitude_estimation">
                                                        <input *ngIf="!dimension.scale.lower_bound" matInput type="number" placeholder="" formControlName="{{(dimension.name).concat('_value')}}" min="{{dimension.scale.min+1}}"
                                                               (change)="this.task.storeDimensionValue($event, i, dimension.index)" class="magnitude_estimation"
                                                               [disabled]="this.task.countdownsExpired[i]">
                                                        <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i], (dimension.name).concat('_value'), 'required')">
                                                            This field is required
                                                        </mat-error>
                                                        <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i], (dimension.name).concat('_value'), 'min')">
                                                            <span *ngIf="dimension.scale.lower_bound">Min value allowed: {{dimension.scale.min}}</span>
                                                            <span *ngIf="!dimension.scale.lower_bound">Min value allowed: {{dimension.scale.min + 1}}</span>
                                                        </mat-error>

                                                    </mat-form-field>
                                                </ng-container>

                                            </ng-container>

                                            <ng-container *ngIf="dimension.style.orientation=='horizontal'">

                                                <!-- Categorical scale markup -->
                                                <mat-radio-group *ngIf="dimension.scale.type=='categorical'" aria-labelledby="radio-button-label" formControlName="{{(dimension.name).concat('_value')}}">
                                                    <mat-radio-button
                                                            *ngFor="let mapping of dimension.scale.mappings let k=index"
                                                            class="radio-button" value="{{mapping.value}}"
                                                            (change)="this.task.storeDimensionValue($event, i,dimension.index)"
                                                            [disabled]="this.task.countdownsExpired[i]">
                                                        <span>{{mapping.label}}</span>
                                                        <span *ngIf="mapping.description.length>0">({{mapping.description}})</span>
                                                    </mat-radio-button>
                                                </mat-radio-group>
                                            </ng-container>

                                            <div *ngIf="dimension.justification" class="dimension-container dimension-justification">
                                                <div class="dimension-content justification">
                                                    <div class="dimension-text-field">
                                                        <mat-form-field appearance="fill" class="width-100">
                                                            <mat-label>{{dimension.justification.text}}</mat-label>
                                                            <textarea matInput formControlName="{{dimension.name}}_justification" rows="5"></textarea>
                                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_justification'), 'required')">
                                                                This field is required
                                                            </mat-error>
                                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_justification'), 'longer')">
                                                                This justification must have at least {{dimension.justification.min_words}} words.
                                                            </mat-error>
                                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_justification'), 'invalid')">
                                                                You cannot use the selected search engine url as part of the justification.
                                                            </mat-error>
                                                        </mat-form-field>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </ng-container>

                                <ng-container *ngIf="this.task.settings.modality=='pairwise'">

                                    <div *ngIf="dimension.scale" class="dimension-container dimension-scale">
                                        <div *ngIf="dimension.url" class="dimension-counter">b.</div>

                                        <div class="dimension-content-split">

                                            <ng-container *ngIf="dimension.style.orientation=='vertical'">

                                                <ng-container *ngIf="dimension.scale.type=='categorical'">
                                                    <ng-container>
                                                        <div class="dimension-split-inside dimension-box" *ngFor="let test of document.statements; let j=index">
                                                            <p class="spanDocument"> Answer for Statement {{changeletter(j)}}</p>
                                                            <mat-radio-group style="margin-left: 10px;" aria-labelledby="radio-button-label" class="radio-button-group" formControlName="{{(dimension.name).concat('_value_').concat(j)}}">
                                                                <mat-radio-button *ngFor="let mapping of dimension.scale.mapping let k=index"
                                                                                  class="radio-button" value="{{mapping.value}}"
                                                                                  (change)="this.task.storeDimensionValue($event, i, dimension.index)"
                                                                                  [disabled]="this.task.countdownsExpired[i]">
                                                                    <span>{{mapping.label}}</span><span *ngIf="mapping.description.length>0">
                                                                    ({{mapping.description}})</span>
                                                                </mat-radio-button>
                                                            </mat-radio-group>
                                                        </div>
                                                    </ng-container>
                                                </ng-container>

                                                <ng-container *ngIf="dimension.scale.type=='interval'">
                                                    <ng-container>
                                                        <div class="dimension-split-inside dimension-box" *ngFor="let test of document.statements; let j=index">
                                                            <p class="spanDocument"> Answer for Statement {{changeletter(j)}}</p>
                                                            <label style="margin-left:10px;"> Selected value: {{documentsForm[i].controls[(dimension.name).concat('_value_').concat(j)].value}}</label>
                                                            <mat-slider
                                                                    min="{{dimension.scale.min}}" max="{{dimension.scale.max}}"
                                                                    step="{{dimension.scale.step}}" thumbLabel tickInterval="{{dimension.scale.step}}"
                                                                    formControlName="{{(dimension.name).concat('_value_').concat(j)}}"
                                                                    (change)="this.task.storeDimensionValue($event, i,dimension.index); changeValue(document.index,dimension.index+1,j)"
                                                                    [disabled]="this.task.countdownsExpired[i]" value="0">
                                                            </mat-slider>
                                                        </div>
                                                    </ng-container>
                                                </ng-container>

                                                <ng-container *ngIf="dimension.scale.type=='magnitude_estimation'">
                                                    <ng-container *ngFor="let test of document.statements; let j=index">
                                                        <div class="dimension-box">
                                                            <p class="spanDocument"> Answer for Statement {{changeletter(j)}}</p>
                                                            <mat-form-field appearance="fill" style="margin-left: 10px;">
                                                                <mat-label>Value</mat-label>
                                                                <input *ngIf="dimension.scale.lower_bound" matInput type="number" placeholder="" formControlName="{{(dimension.name).concat('_value_').concat(j)}}"
                                                                       min="{{dimension.scale.min}}"
                                                                       (change)="this.task.storeDimensionValue($event, i, dimension.index) ; changeValue(document.index,dimension.index+1,j)"
                                                                       [disabled]="this.task.countdownsExpired[i]" class="magnitude_estimation">
                                                                <input *ngIf="!dimension.scale.lower_bound" matInput type="number" placeholder="" formControlName="{{(dimension.name).concat('_value_').concat(j)}}"
                                                                       min="{{dimension.scale.min+1}}"
                                                                       (change)="this.task.storeDimensionValue($event, i, dimension.index); changeValue(document.index,dimension.index+1,j)" class="magnitude_estimation"
                                                                       [disabled]="this.task.countdownsExpired[i]">
                                                                <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i], (dimension.name).concat('_value_').concat(j), 'required')">
                                                                    This field is required
                                                                </mat-error>
                                                                <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i], (dimension.name).concat('_value_').concat(j), 'min')">
                                                                    <span *ngIf="dimension.scale.lower_bound">Min value allowed: {{dimension.scale.min}}</span>
                                                                    <span *ngIf="!dimension.scale.lower_bound">Min value allowed: {{dimension.scale.min + 1}}</span>
                                                                </mat-error>
                                                            </mat-form-field>
                                                        </div>
                                                    </ng-container>
                                                </ng-container>

                                            </ng-container>

                                            <div *ngIf="dimension.justification" class="dimension-content-split">

                                                <div *ngFor="let test of document.statements; let j=index" class="dimension-box">
                                                    <p class="spanDocument"> Answer justification  {{changeletter(j)}}</p>
                                                    <div class="dimension-text-field" style="margin-left: 10px;">
                                                        <mat-form-field appearance="fill">
                                                            <mat-label>{{dimension.justification.text}}</mat-label>
                                                            <textarea matInput formControlName="{{dimension.name}}_justification_{{j}}" rows="3"></textarea>
                                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_justification_').concat(j), 'required')">
                                                                This field is required
                                                            </mat-error>
                                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_justification_').concat(j), 'longer')">
                                                                This justification must have at least {{dimension.justification.minWords}} words.
                                                            </mat-error>
                                                            <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_justification_').concat(j), 'invalid')">
                                                                You cannot use the selected search engine url as part of the justification.
                                                            </mat-error>
                                                        </mat-form-field>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                </ng-container>


                            </div>

                        </ng-template>

                        <!-- Dimensions markup (matrix style) -->
                        <ng-template #dimensionMatrix let-dimensions="dimensions" let-i="i">

                            <div class="dimension-matrix-container">
                                <div *ngFor="let dimension of dimensions; let j=index" class="dimension-matrix">

                                    <!-- Dimension search engine interface markup -->
                                    <div *ngIf="dimension.url" class="dimension-container dimension-url">
                                        <div class="dimension-content search-engine">
                                            <app-crowd-xplorer
                                                    *ngIf="dimension.url" id="app-crowd-xplorer-{{i}}-{{j}}"
                                                    (resultEmitter)="handleSearchEngineRetrievedResponse($event, document, dimension)"
                                                    (queryEmitter)="this.task.storeSearchEngineUserQuery($event, document, dimension)"
                                                    (selectedRowEmitter)="handleSearchEngineSelectedResponse($event, document, dimension)"
                                                    [countdownExpired]="this.task.countdownsExpired[i]"
                                                    [countdownBehavior]="this.task.settings.countdown_behavior">
                                            </app-crowd-xplorer>

                                            <!-- Dimension search engine url field markup (hidden) -->
                                            <mat-form-field *ngIf="dimension.url" class="url-field">
                                                <input #urlField matInput type="text" formControlName="{{(dimension.name).concat('_url')}}">
                                                <button mat-icon-button matPrefix>
                                                    <mat-icon>{{'arrow_right_alt'}}</mat-icon>
                                                </button>
                                                <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i],(dimension.name).concat('_url'), 'required')">
                                                    This field is required
                                                </mat-error>
                                                <mat-error *ngIf="this.utilsService.checkFormControl(documentsForm[i], (dimension.name).concat('_url'), 'invalidSearchEngineUrl')">
                                                    Please select (or copy & paste) one of the URLs shown above.
                                                </mat-error>
                                            </mat-form-field>

                                        </div>
                                    </div>

                                    <!-- Dimension assessment matrix header markup -->
                                    <mat-radio-group *ngIf="j==0 && dimension.scale">
                                        <div></div>
                                        <div *ngFor="let mapping of dimension.scale.mapping; let k=index">
                                            <div class="matrix-header">
                                                <ng-container>
                                                    <span class="matrix-header-text">{{mapping.label}}</span>
                                                </ng-container>
                                                <ng-container *ngIf="mapping.value">
                                                    <span class="matrix-header-value"> ({{mapping.value}})</span>
                                                </ng-container>
                                            </div>
                                        </div>
                                    </mat-radio-group>

                                    <!-- Dimension assessment fields markup -->
                                    <div *ngIf="dimension.scale">
                                        <mat-radio-group aria-labelledby="radio-button-label" formControlName="{{(dimension.name).concat('_value')}}">
                                            <div>
                                                <p>
                                                    <strong>{{this.utilsService.capitalize(dimension.name)}}:</strong>
                                                    {{dimension.description.toLowerCase()}}
                                                </p>
                                            </div>
                                            <div *ngFor="let mapping of dimension.scale.mapping; let k=index">
                                                <mat-radio-button class="radio-button" value="{{mapping.value}}" (change)="this.task.storeDimensionValue($event, i,dimension.index)"></mat-radio-button>
                                            </div>
                                        </mat-radio-group>
                                    </div>

                                    <!-- Separator markup -->
                                    <mat-divider *ngIf="dimension.style.separator" [inset]="true"></mat-divider>

                                </div>
                            </div>
                        </ng-template>

                        <!-- Dimensions are then shown and filtered according to each position -->
                        <ng-template
                                *ngIf="this.filterDimensions('list', 'top').length>0"
                                [ngTemplateOutlet]="dimensionList"
                                [ngTemplateOutletContext]="{dimensions: this.filterDimensions('list', 'top'), i:i}">
                        </ng-template>
                        <ng-template
                                *ngIf="this.filterDimensions('matrix', 'top').length>0"
                                [ngTemplateOutlet]="dimensionMatrix"
                                [ngTemplateOutletContext]="{dimensions: this.filterDimensions('matrix', 'top'), i:i}">
                        </ng-template>
                        <ng-template
                                *ngIf="this.filterDimensions('list', 'middle').length>0"
                                [ngTemplateOutlet]="dimensionList"
                                [ngTemplateOutletContext]="{dimensions: this.filterDimensions('list', 'middle'), i:i}">
                        </ng-template>
                        <ng-template
                                *ngIf="this.filterDimensions('matrix', 'middle').length>0"
                                [ngTemplateOutlet]="dimensionMatrix"
                                [ngTemplateOutletContext]="{dimensions: this.filterDimensions('matrix', 'middle'), i:i}">
                        </ng-template>
                        <ng-template
                                *ngIf="this.filterDimensions('list', 'bottom').length>0"
                                [ngTemplateOutlet]="dimensionList"
                                [ngTemplateOutletContext]="{dimensions: this.filterDimensions('list', 'bottom'), i:i}">
                        </ng-template>
                        <ng-template
                                *ngIf="this.filterDimensions('matrix', 'bottom').length>0"
                                [ngTemplateOutlet]="dimensionMatrix"
                                [ngTemplateOutletContext]="{dimensions: this.filterDimensions('matrix', 'bottom'), i:i}">
                        </ng-template>

                    </mat-card-content>

                    <!-- "Back", "Next" and "Finish" actions markup -->
                    <mat-card-actions>

                        <button mat-flat-button color="primary" matStepperPrevious *ngIf="i>0"
                                [disabled]="this.sectionService.taskCompleted"
                                (click)="produceData('Back', i); previousStep()">
                            Back
                        </button>
                        <button mat-flat-button color="primary" matStepperNext *ngIf="i+1<this.task.documentsAmount || (i+1>=this.task.documentsAmount && this.task.questionnaireAmountEnd > 0)"
                                [disabled]="((!documentsForm[i].valid || documentsForm[i].status == 'DISABLED' ) || !this.task.searchEngineRetrievedResponses[i] || this.sectionService.taskCompleted || !this.task.checkAnnotationConsistency(i))"
                                (click)="produceData('Next', i); nextStep()">
                            Next
                        </button>

                        <button mat-flat-button color="primary" matStepperNext
                                *ngIf="i+1>=this.task.documentsAmount && this.task.questionnaireAmountEnd == 0"
                                [disabled]="(!documentsForm[i].valid || documentsForm[i].status == 'DISABLED'  || !this.task.searchEngineRetrievedResponses[i] || this.sectionService.taskCompleted || !this.task.checkAnnotationConsistency(i))"
                                (click)="produceData('Finish', i); nextStep();">
                            Finish
                        </button>

                    </mat-card-actions>

                </mat-card>
            </form>
        </div>

    </mat-step>

    <!-- Questionnaire markup -->
    <ng-container *ngFor="let questionnaire of this.task.questionnaires; let i=index">
        <mat-step *ngIf="questionnaire.position=='end' || !questionnaire.position" [stepControl]="questionnairesForm[i]" [editable]="false">
            <ng-template matStepLabel>Q{{i + 1}}</ng-template>
            <app-questionnaire
                    id="questionnaire-end-{{i}}"
                    [step]="i"
                    [position]=questionnaire.position
                    [documentsAmount]="this.task.documentsAmount"
                    [questionnaire]="questionnaire"
                    [questionnaireAmount]="this.task.questionnaireAmount"
                    [questionnaireAmountStart]="this.task.questionnaireAmountStart"
                    [questionnaireAmountEnd]="this.task.questionnaireAmountEnd"
                    [questionnaireForm]="questionnairesForm[i]"
                    [taskCompleted]="this.sectionService.taskCompleted"
                    (questionnaireFilled)="handleQuestionnaireFilled($event)">
            </app-questionnaire>
        </mat-step>
    </ng-container>

    <!-- Outcome markup -->
    <mat-step *ngIf="this.task" [editable]="false">
        <ng-template matStepLabel> Outcome</ng-template>
        <app-outcome-section
                [platformName]="this.configService.environment.platformName"
                [triesAllowed]="this.task.settings.allowed_tries"
                [tryCurrent]="this.task.tryCurrent"
                [messages]="this.task.settings.messages"
                [tokenOutput]="this.task.tokenOutput"
                [completionCode]="this.configService.environment.prolific_completion_code"
                (commentEmitter)="performCommentSaving($event)"
                (performReset)="this.performReset()"
        ></app-outcome-section>
    </mat-step>

</mat-horizontal-stepper>
