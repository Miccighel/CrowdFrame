<!-- First instruction page shown when the worker starts the skeleton -->
<div class="instructions-section" *ngIf="this.sectionService.checkCompleted && this.sectionService.currentSection == 'instructions-section'">
    <mat-card>
        <mat-card-content *ngIf="!this.sectionService.checkCompleted || !this.task.instructionsGeneral">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </mat-card-content>
        <mat-card-content *ngIf="this.sectionService.checkCompleted && this.task.instructionsGeneral">
            <ng-container *ngFor="let instruction of this.task.instructionsGeneral; let i=index">
                <h2 *ngIf="instruction['caption']">{{instruction["caption"]}}</h2>
                <span [innerHTML]="instruction.text"></span>
            </ng-container>
        </mat-card-content>
        <mat-card-actions>
            <button mat-flat-button color="primary" (click)="enableTask()" [disabled]="!this.sectionService.checkCompleted || !this.task.instructionsGeneral">
                Proceed
            </button>
        </mat-card-actions>
    </mat-card>
</div>

<!-- Instructions modal shown on the top  -->
<app-instructions [instructions]="this.task.instructionsGeneral" *ngIf="this.sectionService.instructionsAllowed"></app-instructions>

<!-- Token input section -->
<div id="token-section" class="container" *ngIf="this.sectionService.currentSection == 'token-section'">
    <form [formGroup]="tokenForm">
        <mat-card>
            <mat-card-content>
                <mat-form-field appearance="fill">
                    <mat-label>
                        Insert your input token
                    </mat-label>
                    <input matInput type="text" placeholder="your_mturk_token" formControlName="tokenInput" maxlength="11" class="input-token"
                           (focus)="this.tokenForm.updateValueAndValidity()" (paste)="this.tokenForm.updateValueAndValidity()"
                           (keyup)="this.tokenForm.updateValueAndValidity()" (keydown)="this.tokenForm.updateValueAndValidity()"
                           (keyup.enter)="performTaskSetup()">
                    <mat-error *ngIf="this.utilsService.checkFormControl(tokenForm,'tokenInput', 'required')">
                        This field is required
                    </mat-error>
                    <mat-error *ngIf="this.utilsService.checkFormControl(tokenForm,'tokenInput', 'invalid')">
                        This token input is invalid
                    </mat-error>
                    <mat-error *ngIf="this.utilsService.checkFormControl(tokenForm,'tokenInput', 'maxlength')">
                        This token input should be 11 characters long
                    </mat-error>
                </mat-form-field>
            </mat-card-content>
            <mat-card-actions>
                <button mat-flat-button color="primary" (click)="performTaskSetup()">Start</button>
            </mat-card-actions>
        </mat-card>
    </form>
</div>

<!-- Already started section -->

<div id="already-started-section">
    <app-outcome-section
            *ngIf="!this.sectionService.taskAllowed"
            [platformName]="this.configService.environment.platformName"
            [triesAllowed]="this.task.settings.allowed_tries"
            [tryCurrent]="this.task.tryCurrent"
            [messages]="this.task.settings.messages"
            [tokenOutput]="this.task.tokenOutput"
            [completionCode]="this.configService.environment.prolific_completion_code"
            (commentEmitter)="performCommentSaving($event)"
            (performReset)="this.performReset()"
    ></app-outcome-section>
</div>

<!-- Task body section -->
<mat-horizontal-stepper [linear]="true" labelPosition="bottom" id="stepper" #stepper *ngIf="this.task.settings && this.task.documents && this.task.questionnaires && this.task.dimensions && this.sectionService.taskStarted">

    <!-- Questionnaire markup -->
    <ng-container *ngFor="let questionnaire of this.task.questionnaires; let i=index">
        <mat-step *ngIf="questionnaire.position=='start' || !questionnaire.position" [stepControl]="questionnairesForm[i]" [editable]="false">
            <ng-template matStepLabel>Q{{i + 1}}</ng-template>
            <app-questionnaire
                    id="questionnaire-start-{{i}}"
                    [step]="i"
                    [position]=questionnaire.position
                    [documentsAmount]="this.task.documentsAmount"
                    [questionnaire]="questionnaire"
                    [questionnaireAmount]="this.task.questionnaireAmount"
                    [questionnaireAmountStart]="this.task.questionnaireAmountStart"
                    [questionnaireAmountEnd]="this.task.questionnaireAmountEnd"
                    [questionnaireForm]="questionnairesForm[i]"
                    [taskCompleted]="this.sectionService.taskCompleted"
                    (questionnaireFilled)="handleQuestionnaireFilled($event)">
            </app-questionnaire>
        </mat-step>
    </ng-container>

    <!-- Documents markup -->
    <mat-step *ngFor="let document of this.task.documents; let i=index" [editable]="true">
        <div class=" container">
            <mat-card>

                <!-- Document header markup -->
                <ng-template matStepLabel> S{{document.index + 1}}</ng-template>
                <mat-divider [inset]="true"></mat-divider>
                <mat-card-title>Statement Nr. {{i + 1}}</mat-card-title>
                <mat-divider [inset]="true"></mat-divider>
                <mat-card-content class="pt-16px">

                    <!-- Evaluation instructions markup -->
                    <div *ngIf="this.task.instructionsEvaluationAmount>0" class="evaluation-instructions">
                        <mat-divider [inset]="true"></mat-divider>
                        <h2>Instructions</h2>
                        <mat-divider [inset]="true"></mat-divider>
                        <div *ngFor="let instruction of this.task.instructionsEvaluation">
                            <h2>{{instruction.caption}}</h2>
                            <div [innerHTML]="instruction.text"></div>
                        </div>
                    </div>

                    <!--- Countdown markup --->
                    <div class="countdown sticky" *ngIf="this.task.settings.countdown_time>=0">
                        <h1 class="text-lighter m-0">
                            Time left:
                            <countdown #countdownElement [config]="{ demand: true, leftTime: this.task.documentsCountdownTime[i], format: 'mm:ss' }" (event)="handleCountdown($event, i)"></countdown>
                        </h1>
                    </div>

                    <ng-container *ngIf="(this.task.settings.modality=='pointwise')">
                        <ng-container *ngIf="!(this.task.settings.annotator)">
                            <app-element-pointwise [task]="this.task" [documentIndex]="i"></app-element-pointwise>
                        </ng-container>
                        <ng-container *ngIf="(this.task.settings.annotator)">
                            <app-annotator-laws *ngIf="(this.task.settings.annotator.type=='laws')" [task]="this.task" [documentIndex]="i"></app-annotator-laws>
                            <app-annotator-options *ngIf="(this.task.settings.annotator.type=='options')" [task]="this.task" [documentIndex]="i"></app-annotator-options>
                        </ng-container>
                    </ng-container>
                    <ng-container *ngIf="(this.task.settings.modality=='pairwise')">
                        <app-element-pairwise [task]="this.task" [documentIndex]="i" (formEmitter)="updateAssessmentForm($event, i)"></app-element-pairwise>
                    </ng-container>
                    <app-dimension *ngIf="this.assessmentForms" [task]="this.task" [documentIndex]="i" (formEmitter)="updateAssessmentForm($event, i)"></app-dimension>


                </mat-card-content>

                <!-- "Back", "Next" and "Finish" actions markup -->
                <mat-card-actions *ngIf="this.assessmentForms[i]">
                    <button mat-flat-button color="primary" matStepperPrevious *ngIf="i>0"
                            [disabled]="this.sectionService.taskCompleted"
                            (click)="produceData('Back', i); previousStep()">
                        Back
                    </button>
                    <button mat-flat-button color="primary" matStepperNext *ngIf="i+1<this.task.documentsAmount || (i+1>=this.task.documentsAmount && this.task.questionnaireAmountEnd > 0)"
                            [disabled]="((!assessmentForms[i].valid || assessmentForms[i].status == 'DISABLED' ) || !this.task.searchEngineRetrievedResponses[i] || this.sectionService.taskCompleted || !this.task.checkAnnotationConsistency(i))"
                            (click)="produceData('Next', i); nextStep()">
                        Next
                    </button>
                    <button mat-flat-button color="primary" matStepperNext
                            *ngIf="i+1>=this.task.documentsAmount && this.task.questionnaireAmountEnd == 0"
                            [disabled]="(!assessmentForms[i].valid || assessmentForms[i].status == 'DISABLED'  || !this.task.searchEngineRetrievedResponses[i] || this.sectionService.taskCompleted || !this.task.checkAnnotationConsistency(i))"
                            (click)="produceData('Finish', i); nextStep();">
                        Finish
                    </button>
                </mat-card-actions>
                <mat-card-actions *ngIf="!this.assessmentForms[i]">
                    <button mat-flat-button color="primary" matStepperNext *ngIf="i+1<this.task.documentsAmount || (i+1>=this.task.documentsAmount && this.task.questionnaireAmountEnd > 0)" [disabled]="true">
                        Next
                    </button>
                </mat-card-actions>

            </mat-card>
        </div>

    </mat-step>

    <!-- Questionnaire markup -->
    <ng-container *ngFor="let questionnaire of this.task.questionnaires; let i=index">
        <mat-step *ngIf="questionnaire.position=='end' || !questionnaire.position" [stepControl]="questionnairesForm[i]" [editable]="false">
            <ng-template matStepLabel>Q{{i + 1}}</ng-template>
            <app-questionnaire
                    id="questionnaire-end-{{i}}"
                    [step]="i"
                    [position]=questionnaire.position
                    [documentsAmount]="this.task.documentsAmount"
                    [questionnaire]="questionnaire"
                    [questionnaireAmount]="this.task.questionnaireAmount"
                    [questionnaireAmountStart]="this.task.questionnaireAmountStart"
                    [questionnaireAmountEnd]="this.task.questionnaireAmountEnd"
                    [questionnaireForm]="questionnairesForm[i]"
                    [taskCompleted]="this.sectionService.taskCompleted"
                    (questionnaireFilled)="handleQuestionnaireFilled($event)">
            </app-questionnaire>
        </mat-step>
    </ng-container>

    <!-- Outcome markup -->
    <mat-step *ngIf="this.task" [editable]="false">
        <ng-template matStepLabel> Outcome</ng-template>
        <app-outcome-section
                [platformName]="this.configService.environment.platformName"
                [triesAllowed]="this.task.settings.allowed_tries"
                [tryCurrent]="this.task.tryCurrent"
                [messages]="this.task.settings.messages"
                [tokenOutput]="this.task.tokenOutput"
                [completionCode]="this.configService.environment.prolific_completion_code"
                (commentEmitter)="performCommentSaving($event)"
                (performReset)="this.performReset()"
        ></app-outcome-section>
    </mat-step>

</mat-horizontal-stepper>
