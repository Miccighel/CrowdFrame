<div class="container">
    <form [formGroup]="questionnaireForm">
        <mat-card>

            <mat-divider [inset]="true"></mat-divider>
            <mat-card-title *ngIf="questionnaire.type=='standard'">Please answer the following questions</mat-card-title>
            <mat-card-title *ngIf="questionnaire.type=='crt'">Please answer the following question</mat-card-title>
            <mat-card-title *ngIf="questionnaire.type=='likert'">Please assess the following questions</mat-card-title>
            <mat-divider [inset]="true"></mat-divider>

            <!-- Standard questionnaire markup -->
            <mat-card-content *ngIf="questionnaire.type=='standard' && this.questionnaireForm">
                <ng-container *ngFor="let question of this.questionnaire.questions; let j=index">
                    <app-question [question]="question" [questionForm]="questionnaireForm"></app-question>
                    <ng-container *ngFor="let questionSub of question.questions; let j=index">
                        <div class="indent-1">
                            <app-question [question]="questionSub" [questionForm]="questionnaireForm"></app-question>
                            <ng-container *ngFor="let questionSubSub of questionSub.questions; let j=index">
                                <div class="indent-2">
                                    <app-question [question]="questionSubSub" [questionForm]="questionnaireForm"></app-question>
                                    <ng-container *ngFor="let questionSubSubSub of questionSubSub.questions; let j=index">
                                        <div class="indent-3">
                                            <app-question [question]="questionSubSubSub" [questionForm]="questionnaireForm"></app-question>
                                        </div>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </div>
                    </ng-container>
                </ng-container>
            </mat-card-content>

            <!-- CRT questionnaire markup -->
            <mat-card-content *ngIf="questionnaire.type=='crt'">
                <ng-container *ngFor="let question of questionnaire.questions; let j=index">
                    <p class="questionnaire-question">{{question.text}}</p>
                    <mat-divider [inset]="true"></mat-divider>
                    <mat-form-field appearance="fill">
                        <mat-label>Answer</mat-label>
                        <input matInput type="number" placeholder="0" min="0" formControlName="{{question.name}}" class="questionnaire-value">
                        <mat-error *ngIf="checkFormControl(questionnaireForm,question.name, 'required')">
                            This field is required
                        </mat-error>
                        <mat-error *ngIf="checkFormControl(questionnaireForm,question.name, 'min')">
                            Min value allowed: 0
                        </mat-error>
                        <mat-error *ngIf="checkFormControl(questionnaireForm,question.name, 'max')">
                            Max value allowed: 100
                        </mat-error>
                    </mat-form-field>
                </ng-container>
            </mat-card-content>

            <!-- Likert questionnaire markup -->
            <mat-card-content *ngIf="questionnaire.type=='likert'" class="questionnaire-matrix">
                <p *ngIf="questionnaire.description">{{questionnaire.description}}</p>
                <mat-divider [inset]="true"></mat-divider>
                <div class="matrix-header">
                    <div></div>
                    <div *ngFor="let mapping of questionnaire.mappings; let k=index">
                        <span class="matrix-header-text">{{mapping.label}}</span>
                    </div>
                </div>
                <mat-radio-group aria-labelledby="radio-button-label" *ngFor="let question of questionnaire.questions; let m=index" formControlName="{{question.name}}">
                    <div>
                        <p>{{m + 1}}) {{question.text}}</p>
                    </div>
                    <div *ngFor="let mapping of questionnaire.mappings">
                        <mat-radio-button class="radio-button" value="{{mapping.value}}"></mat-radio-button>
                    </div>
                </mat-radio-group>
            </mat-card-content>

            <!-- Next button markup -->
            <mat-card-actions>
                <p class="form-note">
                    <button mat-flat-button color="primary" matStepperNext
                            *ngIf="position=='start'"
                            [disabled]="(!questionnaireForm.valid || this.sectionService.taskCompleted)"
                            (click)="emitQuestionnaireFilled('Next',step)">
                        Next
                    </button>
                    <button mat-flat-button color="primary" matStepperPrevious
                            *ngIf="step>0 && position=='end'"
                            [disabled]="this.sectionService.taskCompleted"
                            (click)="emitQuestionnaireFilled('Back',step)">
                        Back
                    </button>
                    <button mat-flat-button color="primary" matStepperNext
                            *ngIf="step+1 >= this.questionnaireAmountStart + this.documentsAmount && step+1 < (this.questionnaireAmountStart + this.documentsAmount + this.questionnaireAmountEnd) -1  && position=='end'"
                            [disabled]="!questionnaireForm.valid"
                            (click)="emitQuestionnaireFilled('Next',step)">
                        Next
                    </button>
                    <button mat-flat-button color="primary" matStepperNext
                            *ngIf="step+1 >= (this.questionnaireAmountStart + this.documentsAmount + this.questionnaireAmountEnd) - 1  && position=='end'"
                            [disabled]="questionnaireForm.valid"
                            (click)="emitQuestionnaireFilled('Finish',step)">
                        Finish
                    </button>
                    (*) you have to fill each field to proceed
                </p>
            </mat-card-actions>
        </mat-card>
    </form>
</div>
